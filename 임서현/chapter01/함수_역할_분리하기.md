# 0. ì‹œì‘

ë³€ê²½ ì „ ì½”ë“œ

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AirQualityService {

    private final AirQualityProvider airQualityProvider;
    private final RedisTemplate<Object, Object> redisTemplate;

    private static final String key = "air-quality: ";
    private static final Duration TTL = Duration.ofHours(2);

    public AirQualityResponse getAirQuality() {
        CachedAirQuality cached = (CachedAirQuality) redisTemplate.opsForValue().get(key);
        if (cached != null && cached.isFresh()) {
            return cached.getData();
        }
        return updateAriQuality();
    }

    public AirQualityResponse updateAriQuality() {
        Optional<AirQuality> airQuality = airQualityProvider.getAirQuality();

        // ì‘ë‹µ ì„±ê³µ
        if (airQuality.isPresent()) {
            AirQualityResponse response = createResponse(airQuality);
            saveToCache(response, true);
            return response;
        } else {
            // ì‘ë‹µ ì‹¤íŒ¨
            CachedAirQuality previous = (CachedAirQuality) redisTemplate.opsForValue().get(key);
            if (previous != null) {
                saveToCache(previous.getData(), false);
                return previous.getData();
            }
            throw new BusinessException(AirQualityErrorCode.AIR_QUALITY_SERVICE_UNAVAILABLE);
        }
    }

    private AirQualityResponse createResponse(Optional<AirQuality> airQuality) {
        return AirQualityResponse.builder()
            .grade(airQuality.get().getRow().get(0).getGrade())
            .pm25(airQuality.get().getRow().get(0).getPm25())
            .pm10(airQuality.get().getRow().get(0).getPm10())
            .build();
    }

    private void saveToCache(AirQualityResponse airQualityResponse, boolean fresh) {
        redisTemplate.opsForValue().set(key, new CachedAirQuality(airQualityResponse, fresh), TTL);
    }
}
```

<aside>

**ì½”ë“œ ìš”ì•½**

- `getAirQuality()` : í´ë¼ì´ì–¸íŠ¸ê°€ ë¯¸ì„¸ë¨¼ì§€ ë°ì´í„° ìš”ì²­ ì‹œ ë°˜í™˜í•œë‹¤.
    1. redisì— ìºì‹œê°€ ìˆëŠ”ì§€ í™•ì¸
        - ìˆëŠ” ê²½ìš° - ìºì‹œ ë°˜í™˜
        - ì—†ëŠ” ê²½ìš° - `updateAriQuality()` í˜¸ì¶œ
    2. `updateAirQuality()` : ë¯¸ì„¸ë¨¼ì§€ API í˜¸ì¶œ
        1. ì‘ë‹µ ì„±ê³µ - ë¯¸ì„¸ë¨¼ì§€ ë°ì´í„° ë°˜í™˜
        2. ì‘ë‹µ ì‹¤íŒ¨
            1. ì´ì „ ìš”ì²­ì—ì„œ ì €ì¥í•œ ìºì‹œê°€ ìˆëŠ” ê²½ìš° - ì´ì „ ìºì‹œ ë°˜í™˜
            2. ì´ì „ ìš”ì²­ì—ì„œ ì €ì¥í•œ ìºì‹œê°€ ì—†ëŠ” ê²½ìš° - ì˜ˆì™¸ ë°œìƒ
</aside>

`getAirQuality()`ì— `updatAirQuality()`ê°€ í¬í•¨ë˜ê¸° ë•Œë¬¸ì— `getAirQuality()`ë¥¼ ìš°ì„  ë¦¬íŒ©í„°ë§ í–ˆë‹¤.

# 1. getAirQuality()

**Before**

```java
 public AirQualityResponse getAirQuality() {
        CachedAirQuality cached = (CachedAirQuality) redisTemplate.opsForValue().get(key);
        if (cached != null && cached.isFresh()) {
            return cached.getData();
        }
        return updateAriQuality();
    }
```

**After**

```java
public AirQualityResponse getAirQuality() {
        return getCachedAirQuality().orElseGet(this::updateAriQuality);
    }
```

### 1. í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸°

```java
 public AirQualityResponse getAirQuality() {
		 // ìºì‹œ í™•ì¸
		 // ìˆìŒ
        CachedAirQuality cached = (CachedAirQuality) redisTemplate.opsForValue().get(key);
        if (cached != null && cached.isFresh()) {
            return cached.getData();
        }
	   // ì—†ìŒ
        return updateAriQuality();
    }
```

```java
private Optional<AirQualityResponse> getCachedAirQuality() {
      CachedAirQuality cached = (CachedAirQuality) redisTemplate.opsForValue().get(key);
            if (cached != null && cached.isFresh()) {
            return Optional.ofNullable(cached.getData());
        }
        return Optional.empty();
    }
```

- í•´ë‹¹ í•¨ìˆ˜ê°€ ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ìˆë„ë¡ í•¨ìˆ˜ëª… ì„¤ì •

### 2. ì„ì‹œ ë³€ìˆ˜ë¥¼ ì§ˆì˜ í•¨ìˆ˜ë¡œ ë°”ê¾¸ê¸°

```java
		private Optional<AirQualityResponse> getCachedAirQuality() {
        CachedAirQuality cache = getCache();
        if (cache != null && cache.isFresh()) {
            return Optional.ofNullable(cache.getData());
        }
        return Optional.empty();
    }
    
    private CachedAirQuality getCache(){
       return  (CachedAirQuality) redisTemplate.opsForValue().get(key);
    }
```

- ê°€ë…ì„±ì„ ìœ„í•œ `if-else` ë¶„ê¸°ë¬¸ ì œê±°
- ë¶ˆí•„ìš”í•œ Optional ì¤‘ê°„ ë³€ìˆ˜ ì œê±°
- ì¸ë¼ì¸ ë³€ìˆ˜ë¡œ ë³€ê²½

```java
private Optional<AirQualityResponse> getCachedAirQuality() {
        return Optional.ofNullable(getCache())
                .filter(CachedAirQuality::isFresh)
                .map(CachedAirQuality::getData);
    }
```

### 3. ë§ˆë¬´ë¦¬ getAirQuality() ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½

```java
public AirQualityResponse getAirQuality() {
		 Optional<AirQualityResponse> response = getCachedAirQuality();
        if(response.isPresent()){
	        return response.get();
        }
        return updateAriQuality();
    }
```

- ê°€ë…ì„±ì„ ìœ„í•œ if-else ë¶„ê¸°ë¬¸ ì œê±°
- ë¶ˆí•„ìš”í•œ Optional ì¤‘ê°„ ë³€ìˆ˜ ì œê±°

```java
public AirQualityResponse getAirQuality() {
    return getCachedAirQuality().orElseGet(this::updateAriQuality);
}
```

<aside>

### **ì°¸ê³ ) orElse ì™€ orElseGet()**

1. **orElse()**

ì²˜ìŒì—ëŠ” `getCachedAirQuality().orElse(updateAriQuality());` ë¡œ ë³€ê²½í•˜ê³  í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ëŒë ¸ë‹¤ê°€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆë‹¤.

```java
expected: 3
 but was: 4
org.opentest4j.AssertionFailedError
```

**ì´ìœ **

`orElse()`ëŠ” **eager evaluation (ì„ ê³„ì‚°) ìœ¼ë¡œ ë™ì‘**í•œë‹¤. `orElse(updateAriQuality())` ë¥¼ ì‹¤í–‰í•´ ê°’ì„ ë°›ì•„ ë†“ê³  ê·¸ ë‹¤ìŒ `getCachedAirQuality()`ë¥¼ ì‹¤í–‰í•œë‹¤. ì´ë•Œ return ê°’ì´ `null` ì´ë©´ ë°›ì•„ë‘” ê°’ì„ ë°˜í™˜ í•˜ëŠ” ê²ƒ.

ì¦‰, nullì´ë“  nullì´ ì•„ë‹ˆë“  ë‘˜ ë‹¤ ì‹¤í–‰ ëœë‹¤. `updateAriQuality()` ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë©° Redisì— ì ‘ê·¼ì´ ë°œìƒí•´ ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ ê°’ì´ ë³€ê²½ëë˜ê²Œ í…ŒìŠ¤íŠ¸ì˜ ì‹¤íŒ¨ ì›ì¸ì´ì—ˆë‹¤.

1. **orElseGet()**

`orElseGet()`ì€ `orElse()`ì™€ ë‹¤ë¥´ê²Œ **í›„ê³„ì‚°ìœ¼ë¡œ ë™ì‘**í•œë‹¤. ì¦‰, `null`ì´ ì•„ë‹ˆë©´ ì‹¤í–‰ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í•„ìš”í•  ë•Œë§Œ ì‹¤í–‰ í•  ìˆ˜ ìˆë‹¤.

**ê²°ë¡ **

`return getCachedAirQuality().orElseGet(this::updateAriQuality);` ë¡œ ë³€ê²½í•˜ê³  í…ŒìŠ¤íŠ¸ í†µê³¼í•¨

</aside>

# 2. updateAriQuality()

- Before
    
    ```java
    public AirQualityResponse updateAriQuality() {
            Optional<AirQuality> airQuality = airQualityProvider.getAirQuality();
    
            // ì‘ë‹µ ì„±ê³µ
            if (airQuality.isPresent()) {
                AirQualityResponse response = createResponse(airQuality);
                saveToCache(response, true);
                return response;
            } else {
                // ì‘ë‹µ ì‹¤íŒ¨
                CachedAirQuality previous = (CachedAirQuality) redisTemplate.opsForValue().get(key);
                if (previous != null) {
                    saveToCache(previous.getData(), false);
                    return previous.getData();
                }
                throw new BusinessException(AirQualityErrorCode.AIR_QUALITY_SERVICE_UNAVAILABLE);
            }
        }
    ```
    
- After
    
    ```java
    private AirQualityResponse successfulResponse(AirQuality newAirQuality) {
            AirQualityResponse response = createResponse(newAirQuality);
            saveToCache(response, true);
            return response;
        }
    ```
    

### 1. í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸°

**ì‘ë‹µ ì„±ê³µ**

```java
    private AirQualityResponse successfulResponse(AirQuality newAirQuality){
        AirQualityResponse response = createResponse(newAirQuality);
        saveToCache(response, true);
        return response;
    }
```

- AirQuality ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬

<aside>

### ê³ ë¯¼ğŸ¤”

```java
private AirQualityResponse successfulResponse(AirQuality newAirQuality){
        saveToCache(createResponse(newAirQuality), true);
        return createResponse(newAirQuality);
```

ì±…ì—ì„œëŠ” ìœ„ì™€ ê°™ì´ ì¸ë¼ì¸ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í–ˆë‹¤. ì§€ì—­ ë³€ìˆ˜ê°€ ì—†ëŠ” í¸ì´ ì½”ë“œ ë¶„ë¦¬ì— í¸í•˜ë©° ì´ì— ì œëŒ€ë¡œ ë¦¬íŒ©í„°ë§ ëœ ì½”ë“œê°€ ì„±ëŠ¥ ê°œì„ ì—ë„ ìœ ë¦¬í•˜ê¸° ë•Œë¬¸ì´ë‹¤. 

ê·¸ëŸ°ë° ì´ ê²½ìš° í˜¸ì¶œ íšŸìˆ˜ê°€ ëŠ˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì— ë¬¸ì œê°€ ìƒê¸¸ìˆ˜ë„ ìˆê³ , ê°œì¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ê°€ ì½ê¸° í¸í•´ì„œâ€¦  ê³ ë¯¼í•˜ë‹¤ ê·¸ëƒ¥ ë’€ë‹¤.

*(gptì—ë„ ë¬¼ì–´ë´¤ëŠ”ë° íƒ€ì„ìŠ¤í…œí”„ ìƒì„±, ëœë¤ ID ë“± ê°’ì´ ë‹¬ë¼ì§€ëŠ” ê²½ìš°ë¥¼ ìƒê°í•˜ë©´ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë‚«ë‹¤ê³  í–ˆë‹¤. ë˜í•œ, ì½”ë“œ ì´í•´ ì¸¡ë©´ì—ì„œë„ ë™ì¼í•œ ê°’ì„ì„ í™•ì¸í•˜ê¸°ì—ë„ ì¢‹ë‹¤ê³  í–ˆëŠ”ë° ì§„ì§œì¸ì§€ ì•„ë‹Œì§€ í™•ì¸í•´ë´ì•¼ê² ìœ¼ë‚˜ ë‚˜ëŠ” ë™ì˜ í–ˆê¸° ë•Œë¬¸ì— ê± ì¼ìŒ)* 

</aside>

**ì‘ë‹µ ì‹¤íŒ¨**

```java
    private AirQualityResponse failBackOrThrow() {
        CachedAirQuality previous = (CachedAirQuality) redisTemplate.opsForValue().get(key);
        if (previous != null) {
            saveToCache(previous.getData(), false);
            return previous.getData();
        }
        throw new BusinessException(AirQualityErrorCode.AIR_QUALITY_SERVICE_UNAVAILABLE);
    }
```

- ë§Œë“¤ì–´ë‘” ì§ˆì˜ í•¨ìˆ˜ì´ìš©
- ë¶ˆí•„ìš”í•œ Optional ì¤‘ê°„ ë³€ìˆ˜ ì œê±°

```java
private AirQualityResponse failBackOrThrow() {
        return Optional.ofNullable(getCache())
                .map(cache -> {
                    saveToCache(cache.getData(), false);
                    return cache.getData();
                })
                .orElseThrow(() -> new BusinessException(AirQualityErrorCode.AIR_QUALITY_SERVICE_UNAVAILABLE));
    }
```

### 2. ë§ˆë¬´ë¦¬ updateAriQuality() ì—ì„œ ì´ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½

```java
public AirQualityResponse updateAriQuality() {
        return requestAirQuality()
                .map(this::successfulResponse)
                .orElseGet(this::failBackOrThrow);
    }
```

# 3. ê¸°íƒ€

ì¶”ê°€ì ìœ¼ë¡œ í˜¸ì¶œ ìˆœì„œì™€ ì—­í• ì— ë”°ë¼ ì½”ë“œ ìœ„ì¹˜ë„ ë°”ê¿¨ë‹¤.

- public API
    - getAirQuality()
    - updateAriQuality()
- ë°ì´í„° í˜¸ì¶œ
    - requestAirQuality()
    - getCachedAirQuality()
    - successfulResponse()
    - failBackOrThrow()
- ìœ í‹¸ë¦¬í‹°
    - saveToCache()
    - createResponse()
    - getCache()

# 4. ìµœì¢… ê²°ê³¼

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AirQualityService {

    private final AirQualityProvider airQualityProvider;
    private final RedisTemplate<Object, Object> redisTemplate;

    private static final String key = "air-quality: ";
    private static final Duration TTL = Duration.ofHours(2);

    public AirQualityResponse getAirQuality() {
        return getCachedAirQuality().orElseGet(this::updateAriQuality);
    }

    public AirQualityResponse updateAriQuality() {
        return requestAirQuality()
                .map(this::successfulResponse)
                .orElseGet(this::failBackOrThrow);
    }

    private Optional<AirQualityResponse> getCachedAirQuality() {
        return Optional.ofNullable(getCache())
                .filter(CachedAirQuality::isFresh)
                .map(CachedAirQuality::getData);
    }

    private AirQualityResponse successfulResponse(AirQuality newAirQuality) {
        AirQualityResponse response = createResponse(newAirQuality);
        saveToCache(response, true);
        return response;
    }

    private AirQualityResponse failBackOrThrow() {
        return Optional.ofNullable(getCache())
                .map(cache -> {
                    saveToCache(cache.getData(), false);
                    return cache.getData();
                })
                .orElseThrow(() -> new BusinessException(AirQualityErrorCode.AIR_QUALITY_SERVICE_UNAVAILABLE));
    }

    private void saveToCache(AirQualityResponse airQualityResponse, boolean fresh) {
        redisTemplate.opsForValue().set(key, new CachedAirQuality(airQualityResponse, fresh), TTL);
    }

    private CachedAirQuality getCache() {
        return (CachedAirQuality) redisTemplate.opsForValue().get(key);
    }

    private Optional<AirQuality> requestAirQuality() {
        return airQualityProvider.getAirQuality();
    }

    private AirQualityResponse createResponse(AirQuality airQuality) {
        return AirQualityResponse.builder()
                .grade(airQuality.getRow().get(0).getGrade())
                .pm25(airQuality.getRow().get(0).getPm25())
                .pm10(airQuality.getRow().get(0).getPm10())
                .build();
    }
}
```

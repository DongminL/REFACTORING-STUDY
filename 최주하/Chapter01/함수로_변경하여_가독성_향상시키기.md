# JwtService: reissue ë¦¬íŒ©í† ë§
## ë¦¬íŒ©í† ë§

> **7.4 ì„ì‹œ ë³€ìˆ˜ë¥¼ ì§ˆì˜ í•¨ìˆ˜ë¡œ ë°”ê¾¸ê¸°**
> 

```java
        String memberIdFromAccessToken = claimsAccessToken.getSubject();
        String memberIdFromRefreshToken = claimsRefreshToken.getSubject();

        if (!memberIdFromRefreshToken.equals(memberIdFromAccessToken)) {
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        if (jwtUtil.checkBlacklist(extractAccessToken)) {
            logout(accessToken);
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        jwtUtil.validateAccessTokenExpiration(claimsAccessToken, extractAccessToken);

        String existingRefreshToken = refreshTokenRepository.findByMemberId(
            ***memberIdFromRefreshToken***);
        if (existingRefreshToken == null) {
            throw new BusinessException(AuthErrorCode.UNAUTHORIZED);
        }
```

ê¸°ì¡´ì—ëŠ” memberIdFrom~Token ë³€ìˆ˜ì— getSubject()ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ë³€ìˆ˜ì—ì„œëŠ” ì˜ë„ê°€ ëª…í™•í•˜ì§€ë§Œ, getSubject()ëŠ” ì˜ë„ê°€ ë¶ˆë¶„ëª…í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, **7.4 ì„ì‹œ ë³€ìˆ˜ë¥¼ ì§ˆì˜ í•¨ìˆ˜ë¡œ ë°”ê¾¸ê¸°** ê¸°ë²•ì„ ì‚¬ìš©í•´ ë¦¬íŒ©í† ë§ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

> ğŸ“Œìœˆë„ìš° í™˜ê²½ì—ì„œ, ì¸í…”ë¦¬ì œì´ **ë©”ì„œë“œ ì¶”ì¶œ** ë‹¨ì¶•í‚¤ëŠ” **`ctrl + Alt + M`**


```java
String memberIdFromAccessToken = getMemberIdFromClaims(claimsAccessToken);
String memberIdFromRefreshToken = getMemberIdFromClaims(claimsRefreshToken);

private String getMemberIdFromClaims(Claims claims) {
        return claims.getSubject();
}
```

ì´ë ‡ê²Œ ë¦¬íŒ©í† ë§ì„ í•˜ì—¬ getSubjectë¥¼ ì‚¬ìš©í–ˆì„ ë•Œë³´ë‹¤ **Claimsì—ì„œ Idë¥¼ íŒŒì‹±í•œë‹¤ëŠ” ëª©ì ì„ ë” ëª…í™•íˆ** í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
<br><br><br>
> **6.1 í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸°**
> 
- ë¦¬í”„ë ˆì‹œ í† í° ê²€ì¦

```java
        String existingRefreshToken = refreshTokenRepository.findByMemberId(
            memberIdFromRefreshToken);

        if (existingRefreshToken == null) {
            throw new BusinessException(AuthErrorCode.UNAUTHORIZED);
        }
```

ìœ„ì˜ ë¡œì§ì€ ì¿ í‚¤ì— ë“¤ì–´ìˆëŠ” ë¦¬í”„ë ˆì‹œ í† í°ì„ ê²€ì¦í•©ë‹ˆë‹¤. í•œ ëˆˆì— íŒŒì•…í•˜ê¸° ì–´ë µë‹¤ê³  ìƒê°í•˜ì—¬ **`validateRefreshToken`**ì˜ ì´ë¦„ìœ¼ë¡œ ë©”ì„œë“œë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.

```java
    private void validateRefreshToken(String memberIdFromRefreshToken) {
        String existingRefreshToken = refreshTokenRepository.findByMemberId(
            memberIdFromRefreshToken);

        if (existingRefreshToken == null) {
            throw new BusinessException(AuthErrorCode.UNAUTHORIZED);
        }
    }
```

- ì¸ì¦ ë¡œì§

```java
        CustomUserDetails customUserDetails = (CustomUserDetails) authentication.getPrincipal();
        Authentication newAuthentication = new UsernamePasswordAuthenticationToken(
            customUserDetails, null, customUserDetails.getAuthorities());
        SecurityContextHolder.getContext().setAuthentication(newAuthentication);

```

ì¸ì¦ ë¡œì§ì€ ìƒˆë¡œìš´ Authentication ê°ì²´ë¥¼ SecurityContextHolderì— ë„£ëŠ” ê³¼ì •ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì„ ê·¸ëŒ€ë¡œ ë©”ì¸ ë¡œì§ì— ë‹´ê¸°ë³´ë‹¤ëŠ” **`setNewAuthentication`** ì´ë¼ëŠ” ì´ë¦„ì˜ ë©”ì„œë“œë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ê°€ë…ì„±ì„ í–¥ìƒ ì‹œí‚¬ ìˆ˜ ìˆì„ ê²ƒì´ë¼ íŒë‹¨í•˜ì—¬ ë©”ì„œë“œ ì¶”ì¶œì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

```java
    private void setNewAuthentication(Authentication authentication) {
        CustomUserDetails customUserDetails = (CustomUserDetails) authentication.getPrincipal();
        Authentication newAuthentication = new UsernamePasswordAuthenticationToken(
            customUserDetails, null, customUserDetails.getAuthorities());
        SecurityContextHolder.getContext().setAuthentication(newAuthentication);
    }
```
<br><br><br>
## ê³ ë¯¼í–ˆìœ¼ë‚˜ ì ìš©í•˜ì§€ ì•Šì€ ê²ƒë“¤.

### 6.4 ë³€ìˆ˜ ì¸ë¼ì¸

memberIdFrom~Tokenì´ getMemberIdFromTokenì„ í˜¸ì¶œí•˜ëŠ” ì—­í• ë§Œ í•˜ê¸° ë•Œë¬¸ì— **6.4 ë³€ìˆ˜ ì¸ë¼ì¸** ë¦¬íŒ©í„°ë§ ê¸°ë²•ì„ ì ìš©í•´ì•¼ í•˜ë‚˜ ê³ ë¯¼í–ˆìœ¼ë‚˜, ë‹¤ìŒê³¼ ê°™ì€ ì´ìœ ë¡œ ì§„í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

```java
        if (!***getMemberIdFromClaims(claimsRefreshToken)***.equals(***getMemberIdFromClaims(claimsAccessToken)***)) {
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        if (jwtUtil.checkBlacklist(accessTokenWithoutPrefix)) {
            logout(accessToken);
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        jwtUtil.validateAccessTokenExpiration(claimsAccessToken, accessTokenWithoutPrefix);

        validateRefreshToken(***getMemberIdFromClaims(claimsRefreshToken)***);
```

- memberIdFromRefreshTokenì€ ë‘ ë²ˆ ì‚¬ìš©ëœë‹¤.
- ë³€ìˆ˜  ì¸ë¼ì¸ì„ í•˜ë©´, ì¡°ê±´ì‹ì´ ë„ˆë¬´ ê¸¸ì–´ì ¸ ì˜¤íˆë ¤ ê°€ë…ì„±ì„ í•´ì¹  ê²ƒ ê°™ë‹¤.
- memberIdFromAccessTokenì€ í•œ ë²ˆ ì‚¬ìš©ë˜ì§€ë§Œ, í†µì¼ì„±ì„ ìœ„í•´ì„œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë‚«ë‹¤ê³  ìƒê°í–ˆë‹¤.
<br><br>
### 6.1 í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸° - 1

ë˜í•œ, ë¦¬íŒ©í† ë§ ì´ˆë°˜ì—ëŠ” ì•„ë˜ì˜ ì½”ë“œì— **6.1 í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸°**ë¥¼ ì ìš©í•˜ë ¤ê³  í–ˆìŠµë‹ˆë‹¤.

```java
        if (!memberIdFromRefreshToken.equals(memberIdFromAccessToken)) {
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        if (jwtUtil.checkBlacklist(extractAccessToken)) {
            logout(accessToken);
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }
```

ê·¸ëŸ¬ë‚˜, ì½”ë“œì˜ ëª©ì ì„ íŒŒì•…í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì§€ ì•Šì„ ê²ƒ ê°™ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ë¶€ë¶„ì€ ì¸ë¼ì¸ì˜ í˜•íƒœë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒìœ¼ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.
<br><br>
### 6.1 í•¨ìˆ˜ ì¶”ì¶œí•˜ê¸° - 2

```java
        Authentication authentication = jwtUtil.getAuthentication(refreshToken);
        String newAccessToken = jwtUtil.generateAccessToken(authentication);
        String newRefreshToken = jwtUtil.generateRefreshToken(authentication);

```

í† í°ì„ ìƒˆë¡œ ë§Œë“œëŠ” ë¶€ë¶„ë„ generateNewTokenìœ¼ë¡œ ì¶”ì¶œí•˜ë ¤ê³  í–ˆìœ¼ë‚˜, ì—¬ëŸ¬ ê°œì˜ ê°’ì„ ë°˜í™˜í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ë˜ê¸° ë•Œë¬¸ì— ê·¸ëŒ€ë¡œ ë‘ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.
<br><br><br>
## ìµœì¢… ê²°ê³¼ ì½”ë“œ
```java
    public NewTokenResponse reissue(String accessToken, String refreshToken) {
        log.info("accessToken: {} refreshToken: {}", accessToken, refreshToken);
        String accessTokenWithoutPrefix = jwtUtil.extractAccessToken(accessToken);

        Claims claimsAccessToken = jwtUtil.extractClaimsOrThrow("accessToken", accessTokenWithoutPrefix);
        Claims claimsRefreshToken = jwtUtil.extractClaimsOrThrow("refreshToken", refreshToken);

        String memberIdFromAccessToken = getMemberIdFromToken(claimsAccessToken);
        String memberIdFromRefreshToken = getMemberIdFromToken(claimsRefreshToken);

        if (!memberIdFromRefreshToken.equals(memberIdFromAccessToken)) {
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        if (jwtUtil.checkBlacklist(accessTokenWithoutPrefix)) {
            logout(accessToken);
            throw new BusinessException(GlobalErrorCode.BAD_REQUEST);
        }

        jwtUtil.validateAccessTokenExpiration(claimsAccessToken, accessTokenWithoutPrefix);

        validateRefreshToken(memberIdFromRefreshToken);

        Authentication authentication = jwtUtil.getAuthentication(refreshToken);
        String newAccessToken = jwtUtil.generateAccessToken(authentication);
        String newRefreshToken = jwtUtil.generateRefreshToken(authentication);

        setNewAuthentication(authentication);

        return new NewTokenResponse(newAccessToken, newRefreshToken);
    }
```
